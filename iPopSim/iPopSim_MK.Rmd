---
title: "Individual-Based Population Simulator"
subtitle: "V1.7X, CAPAM 2017"
author: "M Kapur adapted from Chang, Carvalho"
output: NULL
---
The purpose of this script is to extend an existing Individual Based Model to act as an operating model of a low-fecund fishery, the Blue shark. This code builds upon the prior forms in the following ways:
+ addition of a low-fecundity stock-recruitment relationship [citation]
+ general cleanup and shortening of functions; system presets and functions are migrated to separate script system_presets.R
+ ! add BSH LFSR
+ Remove time-varying growth

```{r Setup, message = F, results='hide', echo = F}
library(lattice)
require(dplyr)
require(purrr)
library(RColorBrewer)
require(tidyr)
require(ggplot2)
# devtools::install_github("mkapur/kaputils")
# install.packages( "c:/users/maia kapur/dropbox/kaputils",  repos = NULL, type = "source", dependencies = T)
library(kaputils)
rm(list = ls())
```

Establish Presets & Scenarios

```{r}
options(warn = -1)
nboot <- 100
fLevs <- read.csv('inputs/scenarios.csv',na.strings = 'NA') ## manual file
source('wrangle_data.R')
```

Initialization (Calculate SSB per recruit)
These all iterate across ages at a yearly time step. Some modules like growth accumulate at a 1/2 year time step.
Current run time:
50 boots, 100 years ~15mins on sebastes
```{r Run Simulation and Save Outputs}

fdf <- data.frame(); idx <- 1
p = proc.time() ## set timer
# for(l in 1:nrow(fLevs)){
for(l in c(35:40)){

  ## if there's a spatial break
  if (fLevs[l, 'CAT'] == 'SPATIAL'  |
      fLevs[l, "CAT"] == 'COMBO') {
      ## special VB params
      source(paste0(getwd(),"/vb_params_", fLevs[l, 'REG'], '.R'))
      } else {
      source(paste0(getwd(),"/vb_params_R1.R"))
      }
  
  
  source('system_presets.R') ## system functions 
  
  scenname <- paste0(getwd(),"/",fLevs[l,'DESC'])
  scenID <-
    ifelse(is.na(fLevs[l, 5]),
    paste(fLevs[l, 3], fLevs[l, 4], sep = "_"),
    paste(fLevs[l, 3], fLevs[l, 4], fLevs[l, 5],  sep = "_"))
  regID <- ifelse(!is.na(fLevs[l,8]),paste(fLevs[l,8]),"")
  out_file0 <- paste0(scenname,"/",regID); 
  if(!exists(out_file0)) {dir.create(out_file0, showWarnings = F)}

  out_file <-  paste0(out_file0,"/",scenID); dir.create(out_file, showWarnings = F)
  ## Remove pre-existing MATRIX files
  # if(exists(out_file)) unlink(out_file, recursive=TRUE) ## delete pre-existing file
  # dir.create(out_file) ## make master FLevel File
  
  for(boot_number in 1:nboot) { ## full nsims, line 20
    cat(paste0(paste(fLevs[l,'DESC']," ",fLevs[l,'ID']),' boot ',boot_number, "\n"))
    ## Designate WRITE location
    path_name <- paste0(out_file,"/boot_",boot_number) 
    dir.create(path_name, showWarnings = F) ## make individual sim file
    maketables(path_name) ## overwrite pre-existing tables, in system_presets
    
    init_comp <- NULL
    init_comp[1] <- 1
    for(g in 2:(a2+1)){
      init_comp[g]=init_comp[g-1]*exp(-Inst_M) ## instantaneous survivorship at age
    }
    init_comp[a2+1] = init_comp[a2+1]/(1-exp(-Inst_M)) #plus group
    
    # Length-at-age 
    init_length = NULL
    error = exp(rnorm(1,0,growth_lognormal_SD)-growth_lognormal_SD^2/2)
    init_length[1] = L1*error
    
    for(g in 1:(a2)){
      init_length[g+1] = (init_length[g]+growth_incre(init_length[g]))*error
    }
    # init_length=init_length[1:a2]
    
    # Weight-at-age
    init_weight = lw(init_length)
    # Maturity-at-age
    init_mat = prob_mature(init_length)
    # Eggs-body mass relationship
    init_eggs = 1*init_weight^0
    # Calculate SSB per recruit
    SSB_per_recruit = sum(0.5*init_comp*init_weight*init_mat*init_eggs)
    # initail SSB
    SSB0 = SSB_per_recruit*R0_super
    
    # Lognormal recruitment deviation module
    recruit_dev = rnorm(simu_year,0,sigma_R)
    recruit_dev_adj = (recruit_dev-0.5*sigma_R^2)
    RECRUITs = round(R0_super*exp(recruit_dev_adj)) ## generate estimated recruit vector of length simu_year
    
    SSBy = NULL
    SSBy[1] = SSB0
    
    uni_ind = 0
    
    ## get F vector at two different levels with time break
    nyears <- fLevs[l,c("FMORT_TERM")]
    Inst_F_vector <- vector() ## reset
    Inst_F_vector[1:101] <-   c( ## create final fifty or 34 years
      rep(0, 50),
      generate.effort(level = fLevs[l, "FMORT_1"], nyears = nyears),
      generate.effort(level = fLevs[l, "FMORT_2"], nyears = nyears+1)
    )
    if (nyears == 17) { ## add in last 17 years if needed
      Inst_F_vector[85:101] <-
        generate.effort(level = fLevs[l, "FMORT_3"], nyears = nyears)
    }
    ## save simulated F
    fdf <- rbind(fdf, data.frame(cbind(Inst_F_vector[51:101],
                                       1:51, 
                                       rep(idx, 51), rep(boot_number,51))))
    
    for(ry in 1:simu_year){ ## iterate sim years
      if(RECRUITs[ry] < 1){ ## fail if less than one recruit
        RECRUITs[ry]=1 ## coerce to 1
        print(paste0("!!! Recruitment Fail !!! year ",ry))
      }
      
      # if(ry %% 10 == 0){ ## report every 10 yrs
      #   print(paste0("F LEVEL: ", level, " +",ry," Cohort Years"))
      # }
      
      # current_year_by individual
      RECRUITs_year =  rep(1*(ry-1),RECRUITs[ry]) ## vector that lists current year once for each recruit 
      
      # a loop for running each by ind  
      for(i in 1:length(RECRUITs_year)){   ## iterate through each new recruit
        
        uni_ind <- uni_ind + 1
        accumu_yr_1 <- RECRUITs_year[i]+start_yr   
        
        ## GROWTH MODULE: 
        num_of_chance <- length(Inst_F_vector[ry:length(Inst_F_vector)])
        # num_of_chance =  length(ry:length(Inst_F_vector)) ## find length from current recruitment year to end of fishing mortality vector (includes burn in); number of years left
        
        fish_sizes = NULL
        ind_growth_error = exp(rnorm(1,0,growth_lognormal_SD)-growth_lognormal_SD^2/2) ## set individual growth error
        fish_sizes[1]=L1*ind_growth_error ## establish first size
        
        for(g in 1:(num_of_chance-1)){          # next mid year (interval 1 year)
          fish_sizes[g+1] <- (fish_sizes[g]+growth_incre(fish_sizes[g]))*ind_growth_error
        }
                
    
        # Generate a vector of inst_total mortality for this individual;
        ## inst_M is constant, select F vector from given year to end of F vector and multiply by selectivity across fish's lifetime
        inst_Z_vector = Inst_M + Inst_F_vector[ry:length(Inst_F_vector)]*selectivity(fish_sizes)  
         # subset the fish size from the full size-at-age vector (only those that survive grow)
        
         # fish_sizes = fish_sizes[1:a2] ## cut fish_sizes down to max age - this causes problems with multiplication if before inst_z_vector
        inst_Z_vector = inst_Z_vector[1:a2]
        # if(length(inst_Z_vector) >a2){print('length fish size > a2 line 111')}
        

        # random number r1 - bernoulli trial
        r1 = runif(length(inst_Z_vector), 0, 1)
        Zdeath = which.max(r1 <= (1 - exp(-inst_Z_vector))) ## index where r1 is first less than probability of survival (incorporates change)
        fish_sizes = fish_sizes[1:Zdeath] ## trim fish_sizes to time at death
        if(length(fish_sizes) >a2){print('length fish size > a2 line 179')}
        
        ## SIZE-AT-TIME BOOKKEEPING 
        true_age = 1:Zdeath-1 ## actual lifespan before zdeath
        AgeE = rnorm(length(true_age),mean_age_true_age[true_age+1],mean_SD_age_true_age[true_age+1]) 
        AgeE[AgeE<0]=0
        
        SAA <- data.frame(
          cohort = rep(ry, Zdeath),
          uni_ind = rep(uni_ind, Zdeath), ## changed this to rep length Zdeath so it'd match
          ind = rep(i, Zdeath),
          fish_size = fish_sizes[1:Zdeath],
          Year = accumu_yr_1 + 1:Zdeath - 1,
          Age = true_age,
          AgeE = AgeE,
          FMORT = c(Inst_F_vector[ry:(ry + Zdeath - 1)]),
          M = rep(Inst_M, Zdeath),  ## changed this to rep length Zdeath so it'd match
          Sel = c(selectivity(fish_sizes)),
           # Sel = c(selectivity(true_age)),

          FSIM = paste(fLevs[l,"FMORT_1"],fLevs[l,"FMORT_2"],fLevs[l,"FMORT_3"]),
          REG = fLevs[l,"REG"]
        )
        
        ## MORTALITY MODULE:
        # seperate inst_total mortality into F and M
        M_dead_por = (1 - exp(-Inst_M)) / (1 - exp(-inst_Z_vector[Zdeath])) ## nat survivorship over overall survivorship. Will be 1 for years with only nat mort in effect.
        r2 = runif(1, 0, 1) ## bernoulli trial
        true_age = Zdeath - 1
        AgeE = rnorm(1, mean_age_true_age[true_age + 1], mean_SD_age_true_age[true_age +
        1])
        AgeE[AgeE < 0] = 0
        
        ## write dinfo 
        dinfo = data.frame(
          cohort = c(ry),
          ind = c(i),
          fish_size = fish_sizes[Zdeath],
          Year = accumu_yr_1 + Zdeath - 1,
          Age = true_age,
          AgeE = AgeE,
          dtype = NA, ## fill in next based on log-odds (r2)
          FMORT = c(Inst_F_vector[ry + Zdeath - 1]),
          M = c(Inst_M),
          Sel = c(selectivity(fish_sizes[Zdeath])),

          FSIM = paste(fLevs[l,"FMORT_1"],fLevs[l,"FMORT_2"],fLevs[l,"FMORT_3"]),
          REG = fLevs[l,"REG"]

        )
        
        dinfo$dtype = ifelse(r2 <= M_dead_por, "M", "FISHED")
        
        ## write data to file - one for each F level

        
                write.table(SAA, paste(path_name,"/IBM_SAA_MATRIX.txt",sep=""),append = TRUE,row.names = FALSE,col.names = FALSE,sep=",")
        write.table(dinfo,paste(path_name,"/IBM_DEAD_MATRIX.txt",sep=""),append = TRUE,row.names = FALSE,col.names = FALSE,sep=",")
        

      } ## end of individual recruit
      
      ## STOCK-RECRUITMENT MODULE
        # Update number of recruits by B-H stock recruitment relationship
        # Recruitment derived from B-H S-R start from the second year of fishing mortality
        
        if (ry > M_only_yr & ry <= (simu_year - 1)) { ## only perform SRR for years after M only and before last year
          tempSAA = read.table(paste0(path_name, "/IBM_SAA_MATRIX.txt"),header = T, sep = ',') ## read current size-at-age-table
          tempN = subset(tempSAA, Year == (ry + start_yr - 1)) ## extract PREVIOUS year
          tempW = lw(tempN$fish_size) ## calc weights
          tempMat = prob_mature(tempN$fish_size) ## calc prob of maturity at size
          tempE = 1 * tempW ^ 0 ## ! unsure
          SSBy[ry] = sum(tempW * tempMat * tempE) / 2 ## SSB for this year (half step) is the sum of all biomasses & prob maturity
          RECRUITs[ry + 1] = round(BH_SR(SSBy[ry]) * exp(recruit_dev_adj[ry])) ## next year's recruits are the bev-holt or LFSR of the SSB with error
        } ## end of recruitment generation for that year
    } ## end of simu_year (ry)





## Bind all & Save
# p = proc.time()
    
IBM_SAA_MATRIX = read.table(paste0(path_name,"/IBM_SAA_MATRIX.txt"),sep=",",header=T)
IBM_DEAD_MATRIX = read.table(paste0(path_name,"/IBM_DEAD_MATRIX.txt"),sep=",",header=T)

# IBM_SAA_MATRIX = rbind(read.table(paste0(path_name,"/IBM_SAA_MATRIX_LOW.txt"),sep=",",header=T),
#                        read.table(paste0(path_name,"/IBM_SAA_MATRIX_MED.txt"),sep=",",header=T),
#                        read.table(paste0(path_name,"/IBM_SAA_MATRIX_HIGH.txt"),sep=",",header=T))

# IBM_DEAD_MATRIX = rbind(read.table(paste0(path_name,"/IBM_DEAD_MATRIX_LOW.txt"),sep=",",header=T),
#                         read.table(paste0(path_name,"/IBM_DEAD_MATRIX_MED.txt"),sep=",",header=T),
#                         read.table(paste0(path_name,"/IBM_DEAD_MATRIX_HIGH.txt"),sep=",",header=T))

# write.table(IBM_SAA_MATRIX,paste0(path_name,"/IBM_SAA_MATRIX.txt"),
#             row.names = FALSE,col.names = T,sep=",")
# write.table(IBM_DEAD_MATRIX,paste0(path_name,"/IBM_DEAD_MATRIX.txt"),
#             row.names = FALSE,col.names = T,sep=",")

## Generate Exploitable population
IBM_EXP_MATRIX = NULL
for(i in start_yr:(start_yr+simu_year-1)){
  # print(paste("Year = ", i))
  temp_Year = subset(IBM_SAA_MATRIX, Year==i)
  r3 = runif(length(temp_Year[,1]),0,1)
  index = which(r3 <= selectivity(temp_Year$fish_size))
  EXP_info = temp_Year[index,]
  write.table(EXP_info,paste0(path_name,"/IBM_EXP_MATRIX.txt"),append = TRUE,
              row.names = FALSE,col.names = FALSE,sep=",")
  IBM_EXP_MATRIX = rbind(IBM_EXP_MATRIX,EXP_info)
} # end of year


## Generate Catch Matrix
CATCH_MATRIX = subset(IBM_DEAD_MATRIX, dtype=="FISHED") ## all records of fishing death
write.table(CATCH_MATRIX,paste0(path_name, "/CATCH_MATRIX.csv",sep=""),row.names = FALSE,col.names = TRUE,sep=",")

IBM_EXP_MATRIX = read.table(paste0(path_name,"/IBM_EXP_MATRIX.txt"),sep=",",header=T) 
CATCH_MATRIX = read.table(paste0(path_name,"/CATCH_MATRIX.csv"),sep=",",header=T) 


## SS3 SIZE COMPOSITION ----
SS3_Obs_Size_COM_MinBin = 5
SS3_Obs_Size_COM_MaxBin = 1005
Obs_Size_COM_bin_interval = 10
Effect_N = 100

OBS_size_bin = seq(SS3_Obs_Size_COM_MinBin,SS3_Obs_Size_COM_MaxBin,Obs_Size_COM_bin_interval) 
lower_OBS_size_bin = OBS_size_bin[-length(OBS_size_bin)]
N_obs_size_bin = length(lower_OBS_size_bin)

OBS_SIZE_COM = NULL
por_TRUE_SIZE_COM = NULL
por_OBS_SIZE_COM = NULL

for(y in (start_yr+M_only_yr):(start_yr+simu_year-1)){
  temp_Year = subset(CATCH_MATRIX, Year==y)
  
  if(length(temp_Year[,1])>=1){
    # lower bin
    hist_data = hist(temp_Year$fish_size,right=F,breaks=OBS_size_bin,plot=FALSE)  
    temp_true_catch_com = hist_data$counts/sum(hist_data$counts)
    por_TRUE_SIZE_COM = rbind(por_TRUE_SIZE_COM,temp_true_catch_com)
    
    catch_com_new = NULL
    temp_por_OBS_SIZE_COM = NULL
    for(i in 1:length(temp_true_catch_com)){
      n_count = 0
      for(j in 1:Effect_N){
        r4=runif(1, min=0, max=1)
        if(r4<=temp_true_catch_com[i]){
          n_count=n_count+1
        }
      }
      catch_com_new[i]=n_count
      temp_por_OBS_SIZE_COM[i] = n_count/Effect_N
    }
    por_OBS_SIZE_COM = rbind(por_OBS_SIZE_COM,temp_por_OBS_SIZE_COM)
    #Yr","Seas","Flt","Gender","Part","Nsamp"
    OBS_SIZE_COM = rbind(OBS_SIZE_COM,c(y,   1,      1,    0,      0,      Effect_N,catch_com_new))
  } # end of if 
}
colnames(OBS_SIZE_COM) <-  c("#Yr","Seas","Flt","Gender","Part","Nsamp",lower_OBS_size_bin)
colnames(por_OBS_SIZE_COM) <-  c(lower_OBS_size_bin)


write.table("#_N_LengthBins",paste0(path_name, "/SS3_OBS_Size_COM.csv",sep=""),row.names=FALSE,col.names=FALSE,sep=",",append = T) 
write.table(N_obs_size_bin,paste0(path_name, "/SS3_OBS_Size_COM.csv",sep=""),row.names=FALSE,col.names=FALSE,sep=",",append = T)
write.table(t(lower_OBS_size_bin),paste0(path_name, "/SS3_OBS_Size_COM.csv",sep=""),row.names=FALSE,col.names=FALSE,sep=",",append = T)

write.table("#_N_Length_obs",paste0(path_name, "/SS3_OBS_Size_COM.csv",sep=""),row.names=FALSE,col.names=FALSE,sep=",",append = T)  
N_size_observation = length(OBS_SIZE_COM[,1])
write.table(t(N_size_observation),paste0(path_name, "/SS3_OBS_Size_COM.csv",sep=""),row.names=FALSE,col.names=FALSE,sep=",",append = T) 

# data-vector
write.table(t(colnames(OBS_SIZE_COM)),paste0(path_name, "/SS3_OBS_Size_COM.csv",sep=""),row.names=FALSE,col.names=FALSE,sep=",",append = T) 
write.table(OBS_SIZE_COM,paste0(path_name, "/SS3_OBS_Size_COM.csv"),row.names=FALSE,col.names=FALSE,sep=",",append = T)

# print(paste0('wrote SS3 OBS size comp, sim ',sim_number," FLEVEL ",level))

## SS3 AGE COMPOSITION ----
# file.remove(paste0(path_name, "/SS3_OBS_AgeE_COM.csv",sep=""))

max_IBM_age =  max(max(CATCH_MATRIX$AgeE),max(CATCH_MATRIX$Age),max(IBM_SAA_MATRIX$Age))
if(max_IBM_age>a2){
  full_age_breaks = c(c(0:a2),(max_IBM_age+0.5)) # a2:max_IBM_age as plus group
}else{
  full_age_breaks = c(c(0:(a2+1)))               # a2 as plus group
}


lower_age_bin = full_age_breaks[-length(full_age_breaks)]

OBS_full_AgeE_COM = NULL   
por_full_Agetrue_COM = NULL
por_full_AgeE_COM = NULL
por_OBS_AgeE_COM = NULL


for(y in unique(CATCH_MATRIX$Year)){
  temp_Year = subset(CATCH_MATRIX, Year==y) ## only works where a fish died in that year
  
  for(k in 1:length(OBS_size_bin-1)){
    temp_conditional_size = subset(temp_Year,temp_Year$fish_size >= OBS_size_bin[k] & temp_Year$fish_size < OBS_size_bin[k+1])
    
    
    if(length(temp_conditional_size[, 1])>=1) {
      
      hist_data_Agetrue = hist(temp_conditional_size$Age,right=F,breaks=full_age_breaks,plot=FALSE) 
      hist_data_AgeE = hist(temp_conditional_size$AgeE,right=F,breaks=full_age_breaks,plot=FALSE)
      
      temp_data_Agetrue = hist_data_Agetrue$counts/sum(hist_data_Agetrue$counts) 
      temp_data_AgeE = hist_data_AgeE$counts/sum(hist_data_AgeE$counts)
      
      por_full_Agetrue_COM = rbind(por_full_Agetrue_COM,temp_data_Agetrue)
      por_full_AgeE_COM = rbind(por_full_AgeE_COM,temp_data_AgeE)
      
      obs_Age_COM = NULL
      temp_por_obs_Age_COM = NULL
      for(i in 1:length(temp_data_AgeE)){
        n_count = 0
        for(j in 1:Effect_N_Age_COM){
          r5=runif(1, min=0, max=1)
          if(r5<=temp_data_AgeE[i]){
            n_count=n_count+1
          }
        }
        obs_Age_COM[i]=n_count
        temp_por_obs_Age_COM[i]=n_count/Effect_N_Age_COM
      }
      por_OBS_AgeE_COM = rbind(por_OBS_AgeE_COM,temp_por_obs_Age_COM)
      
      #Yr","Seas","Flt","Gender","Part", "Ageerr", "Lbin_lo", "Lbin_hi", "Nsamp",           "obs_Age_COM"
      OBS_full_AgeE_COM = rbind(OBS_full_AgeE_COM,c(y,   1,      1,    0,      0,      1,         OBS_size_bin[k],         OBS_size_bin[k],        Effect_N_Age_COM, obs_Age_COM))
      
    } # end of if 
    
  } # end of OBS_size_bin
  
} # end of year

colnames(por_full_Agetrue_COM) <-  c(hist_data_AgeE$breaks[-length(hist_data_AgeE$breaks)]) 
colnames(por_full_AgeE_COM) <-  c(hist_data_AgeE$breaks[-length(hist_data_AgeE$breaks)])   
colnames(por_OBS_AgeE_COM) <-  c(hist_data_AgeE$breaks[-length(hist_data_AgeE$breaks)])   
colnames(OBS_full_AgeE_COM) <-  c("#Yr","Seas","Flt","Gender","Part","Ageerr","Lbin_lo","Lbin_hi","Nsamp",hist_data_AgeE$breaks[-length(hist_data_AgeE$breaks)])

OBS_full_AgeE_COM = as.data.frame(OBS_full_AgeE_COM)
por_full_Agetrue_COM = as.data.frame(por_full_Agetrue_COM)
por_full_AgeE_COM = as.data.frame(por_full_AgeE_COM)

OBS_AgeE_COM = subset(OBS_full_AgeE_COM, select = c("#Yr","Seas","Flt","Gender","Part","Ageerr","Lbin_lo","Lbin_hi","Nsamp",OBS_age_bin))
por_full_Agetrue_COM = subset(por_full_Agetrue_COM, select = paste(OBS_age_bin))
por_full_AgeE_COM = subset(por_full_AgeE_COM, select = paste(OBS_age_bin))
por_OBS_AgeE_COM = subset(por_OBS_AgeE_COM, select = paste(OBS_age_bin))


# Number of OBS_age_bin (age' bin)
N_obs_age_bin = length(OBS_age_bin)
write.table("#_N_age_bins",paste0(path_name, "/SS3_OBS_AgeE_COM.csv",sep=""),row.names=FALSE,col.names=FALSE,sep=",",append = T) 
write.table(t(N_obs_age_bin),paste0(path_name, "/SS3_OBS_AgeE_COM.csv",sep=""),row.names=FALSE,col.names=FALSE,sep=",",append = T) 
write.table(t(OBS_age_bin),paste0(path_name, "/SS3_OBS_AgeE_COM.csv",sep=""),row.names=FALSE,col.names=FALSE,sep=",",append = T) 

# Ageing error
write.table("#_N_ageerror_definitions",paste0(path_name, "/SS3_OBS_AgeE_COM.csv",sep=""),row.names=FALSE,col.names=FALSE,sep=",",append = T)  
write.table("1",paste0(path_name, "/SS3_OBS_AgeE_COM.csv",sep=""),row.names=FALSE,col.names=FALSE,sep=",",append = T)  
# vector of mean age' for each true age  
write.table(t(mean_age_true_age[1:(a2+1)]),paste0(path_name, "/SS3_OBS_AgeE_COM.csv",sep=""),row.names=FALSE,col.names=FALSE,sep=",",append = T)  
# vector of SD of age' for each true age
write.table(t(mean_SD_age_true_age[1:(a2+1)]),paste0(path_name, "/SS3_OBS_AgeE_COM.csv",sep=""),row.names=FALSE,col.names=FALSE,sep=",",append = T) 

N_age_observation = length(OBS_AgeE_COM[,1])
write.table("#_N_Agecomp_obs",paste0(path_name, "/SS3_OBS_AgeE_COM.csv",sep=""),row.names=FALSE,col.names=FALSE,sep=",",append = T) 
write.table(t(N_age_observation),paste0(path_name, "/SS3_OBS_AgeE_COM.csv",sep=""),row.names=FALSE,col.names=FALSE,sep=",",append = T) 

Age_COM_length_bin = 1
write.table("#_Lbin_method: 1=poplenbins; 2=datalenbins; 3=lengths",paste0(path_name, "/SS3_OBS_AgeE_COM.csv",sep=""),row.names=FALSE,col.names=FALSE,sep=",",append = T)  
write.table(t(Age_COM_length_bin),paste0(path_name, "/SS3_OBS_AgeE_COM.csv",sep=""),row.names=FALSE,col.names=FALSE,sep=",",append = T)  

Combine_M_into_F = 1
write.table("#_combine males into females at or below this bin number",paste0(path_name, "/SS3_OBS_AgeE_COM.csv",sep=""),row.names=FALSE,col.names=FALSE,sep=",",append = T)  
write.table(t(Combine_M_into_F),paste0(path_name, "/SS3_OBS_AgeE_COM.csv",sep=""),row.names=FALSE,col.names=FALSE,sep=",",append = T)  

# data-vector
write.table(t(colnames(OBS_AgeE_COM)),paste0(path_name, "/SS3_OBS_AgeE_COM.csv",sep=""),row.names=FALSE,col.names=FALSE,sep=",",append = T) 
write.table(OBS_AgeE_COM,paste0(path_name, "/SS3_OBS_AgeE_COM.csv",sep=""),row.names=FALSE)
# print(paste0('wrote SS3 OBS age comp, sim ',sim_number, " FLEVEL ",level))
## SS3 NUMBER/FISHERY BASED CPUE ----

Exp_POP = NULL
for(i in start_yr:(start_yr+simu_year-1)){
  temp_Year = subset(IBM_EXP_MATRIX,IBM_EXP_MATRIX$Year==i)
  EXP_temp = data.frame(Year=c(i),Exp_number=c(length(temp_Year$fish_size)),Exp_biomass=c(sum(lw(temp_Year$fish_size))))
  Exp_POP = rbind(Exp_POP,EXP_temp)
}

CPUE_error = rnorm(length(Exp_POP[,1]),0,sigma_CPUE)                 
OBS_CPUE = data.frame(Year=c(Exp_POP[,1]),season=c(1),fleet=c(2),CPUE=c(Exp_POP[,2]*fishery_q*exp(CPUE_error-0.5*sigma_CPUE^2)),sd=c(sigma_CPUE))

write.table(OBS_CPUE,paste0(path_name, "/SS3_Fishery_CPUE.csv",sep=""),row.names = FALSE,col.names = TRUE,sep=",") 

## SS3 CATCH DATA----

F_MATRIX = subset(IBM_DEAD_MATRIX,IBM_DEAD_MATRIX$dtype=="F")
M_MATRIX = subset(IBM_DEAD_MATRIX,IBM_DEAD_MATRIX$dtype=="M")

CATCH_wt = NULL
CATCH = NULL
DEATH_wt = NULL 

for(i in start_yr:(start_yr+simu_year-1)){
  temp_Year = subset(F_MATRIX,F_MATRIX$Year==i)
  temp_Year_M = subset(M_MATRIX,M_MATRIX$Year==i)
  CATCH = rbind(CATCH,length(temp_Year[,1]))
  CATCH_wt = rbind(CATCH_wt,sum(lw(temp_Year$fish_size)))
  DEATH_wt = rbind(DEATH_wt,sum(lw(temp_Year_M$fish_size)))
}
catch_out = data.frame(CATCH_num=c(CATCH),CATCH_Kg=c(CATCH_wt),CATCH_ton=c(CATCH_wt)/1000,Year=c(start_yr:(start_yr+simu_year-1)),season=c(1))
write.table(catch_out,paste0(path_name, "/SS3_Catch.csv",sep=""),row.names = FALSE,col.names = TRUE,sep=",") 
# print(paste0('wrote SS3 catch data, sim ',sim_number," FLEVEL ",level))

## SS3 MEAN LENGTH AT AGE ----

# file.remove(paste0(path_name, "/SS3_OBS_Mean_Size_At_AgeE.csv",sep=""))

OBS_Mean_Length_At_Age_RESULT = NULL

for(y in (start_yr+M_only_yr):(start_yr+simu_year-1)){
  
  temp_Year = subset(CATCH_MATRIX,CATCH_MATRIX$Year==y)
  
  temp_mean_size_at_age = NULL
  RESULT_fish_N = NULL
  for(age in 1:(length(full_age_breaks)-1)){
    temp_age = subset(temp_Year,temp_Year$AgeE >= full_age_breaks[age] & temp_Year$AgeE < full_age_breaks[age+1])
    if(length(temp_age[,1])>=Nsamp_Mean_length_at_age){
      index_all = c(1:length(temp_age[,1]))
      sample_index = sample(index_all,Nsamp_Mean_length_at_age,replace = FALSE)
      sample_temp_age = temp_age[sample_index,]
      mean_size_at_age = mean(sample_temp_age$fish_size)
      fish_N = Nsamp_Mean_length_at_age
      temp_mean_size_at_age=rbind(temp_mean_size_at_age,mean_size_at_age)
      RESULT_fish_N = rbind(RESULT_fish_N,fish_N)
    }
    else if(length(temp_age[,1])==0){
      mean_size_at_age = c(-999)
      fish_N = 0 
      temp_mean_size_at_age = rbind(temp_mean_size_at_age,mean_size_at_age) 
      RESULT_fish_N = rbind(RESULT_fish_N,fish_N)
    }
    else{
      mean_size_at_age = mean(temp_age$fish_size)
      fish_N = length(temp_age[,1]) 
      temp_mean_size_at_age = rbind(temp_mean_size_at_age,mean_size_at_age) 
      RESULT_fish_N = rbind(RESULT_fish_N,fish_N) 
    } 
  } # age loop
  #Yr","Seas","Flt","Gender","Part", "Ageerr", "Nsamp", "Mean-size-at-age for each age* " , "N_fish"
  OBS_Mean_Length_At_Age_RESULT = rbind(OBS_Mean_Length_At_Age_RESULT,c(y,   1,      1,    0,      0,      1,        2,     temp_mean_size_at_age,            RESULT_fish_N))
  
} # year loop

colnames(OBS_Mean_Length_At_Age_RESULT) <- c("#Yr","Seas","Flt","Gender","Part","Ageerr","Nsamp",lower_age_bin, paste("N_fish_a",lower_age_bin,sep=""))
OBS_Mean_Length_At_Age_RESULT = as.data.frame(OBS_Mean_Length_At_Age_RESULT)  
OBS_Mean_Length_At_Age_RESULT = subset(OBS_Mean_Length_At_Age_RESULT, select = c("#Yr","Seas","Flt","Gender","Part","Ageerr","Nsamp",OBS_age_bin, paste("N_fish_a",OBS_age_bin,sep="")))

# Number of OBS_age_bin (age' bin)
N_obs_mean_size_at_age = length(OBS_Mean_Length_At_Age_RESULT[,1])
write.table("#_N_MeanSize-at-Age_obs",paste0(path_name, "/SS3_OBS_Mean_Size_At_AgeE.csv",sep=""),row.names=FALSE,col.names=FALSE,sep=",",append = T) 
write.table(t(N_obs_mean_size_at_age),paste0(path_name, "/SS3_OBS_Mean_Size_At_AgeE.csv",sep=""),row.names=FALSE,col.names=FALSE,sep=",",append = T) 

# data-vector
write.table(t(colnames(OBS_Mean_Length_At_Age_RESULT)),paste0(path_name, "/SS3_OBS_Mean_Size_At_AgeE.csv",sep=""),row.names=FALSE,col.names=FALSE,sep=",",append = T) 
write.table(OBS_Mean_Length_At_Age_RESULT,paste0(path_name, "/SS3_OBS_Mean_Size_At_AgeE.csv",sep=""),row.names=FALSE,col.names=FALSE,sep=",",append = T) 
# print(paste0('wrote SS3 mean size at age, sim ',sim_number," FLEVEL ",level))
  } ## end of boots
  idx <- idx + 1
  genDat <- build_simComp(out_file,l=l)
  plotComps(dat1 = genDat[[1]], dat2 = genDat[[2]], datN = genDat[[3]], scenID  = genDat[[4]], saveloc = 1)
  rm(genDat)
} ## end of fishing_level
print(paste("Full simulation time ",((proc.time()-p)/60)[1],"min(s)"))
names(fdf) <- c('F_std','Year','MOD','boot')
fdf$MOD <- as.factor(fdf$MOD)
write.csv(fdf,file=paste0(getwd(),"/genData/Fsim.csv"),row.names = F )
```


Read in both regions' subsampled data frame from each regime; nesting varies depending whether there was a spatial regime or not. Apply breakpoints if specified in `scenarios`. Save this to genData, and plot compiled A-L comp plots to plots/. Now you have a dataset with temporal and spatial breaks as specified.
```{r assign spatial, echo = T}
# for(l in 1:nrow(fLevs)){
for(l in c(1:6,35,36)){
  
  sptl <- fLevs[l,'SPATIAL']
  scenname <- paste0(getwd(),"/",fLevs[l,'DESC'])
  scenID <-
    ifelse(is.na(fLevs[l, 5]),
           paste(fLevs[l, 3], fLevs[l, 4], sep = "_"),
           paste(fLevs[l, 3], fLevs[l, 4], fLevs[l, 5],  sep = "_"))
  regID <- ifelse(!is.na(fLevs[l,8]),paste(fLevs[l,8]),"")
  out_file0 <- paste0(scenname,"/",regID)
  out_file <-  paste0(out_file0,"/",scenID)
    
  if(fLevs[l,'CAT'] %in% c('NONE','SPATIAL')){ ## if spatial only, aggregate all and split regionally
    
    for(b in 1:nboot){ ## pair boots

      dat <- list.files(scenname, full.names = T,recursive = T)[grep(paste0(b,'sim_Comp'),list.files(scenname, full.names = T, recursive = T))] %>%
        lapply(read.csv,sep=",",header=T) %>%
        reduce(bind_rows)
      makeLat(dat) %>% write.csv(., paste0(getwd(),"/genData/",basename(scenname),"_",scenID,"_",b,".csv"),row.names = F)
    }
    # dat <- read.table(paste0(out_file,"/",scenID,b,"sim_Comp.csv"),sep = ",",header = T) %>% filter(Year %in% c(50:100))
    
    # names(dat)[4] <- "fish_size"
    # genDat <- build_simComp(dat0=dat,l=l) ## make stuff for plotting
    # plotComps(dat1 = genDat[[1]], dat2 = genDat[[2]], datN = genDat[[3]], scenID = genDat[[4]], saveloc = NA) ## all regions together
    # names(dat)[4] <- "Length_cm"
    
  }  else if(fLevs[l,'CAT'] %in% c('TEMPORAL', 'COMBO')) { ## merge by flev and region
    for(b in 1:nboot){ ## pair boots
      dat <-
        list.files(out_file, full.names = T, recursive = T)[grep(paste0(b, 'sim_Comp'),
                                                                 list.files(out_file, full.names = T, recursive = T))] %>%  
        lapply(read.csv, sep = ",", header = T) %>% 
        reduce(bind_rows) 
      makeLat(dat) %>% write.csv(., paste0(getwd(),"/genData/",basename(scenname),"_",scenID,"_",b,".csv"),row.names = F)
    } ## end boot
  } ## end else
}  ## end levs
    
    
    # moddrop <- NA
    # for(m in 1:length(lev0)){
    #   if(length(list.dirs(lev0[m], recursive = F)) > 0)  moddrop[m] <- m
    # }
    # moddrop <- moddrop[!is.na(moddrop)]
    # if(length(moddrop >0)) lev0 <- lev0[-moddrop]
    ## get pre-sampled age/length data
    # dat <- list.files(scenname, recursive = T, full.names = T)[grep(paste0(scenID,'sim_Comp.csv'),list.files(scenname, recursive = T, full.names = T))] %>%
    #   lapply(read.csv) %>%
    #   reduce(bind_rows) %>%
    #   filter(Year %in% c(50:100))

## Plot F trajectory one time
 fdf %>% 
   filter(MOD %in% floor(runif(8,1,8)) & boot == 2) %>%
  kaputils::plotF(SPRseries =., saveplot = T, pdfcols = 1, plotloc = "C:/Users/MKapur/Dropbox/UW/sab-growth/iPopSim/plots")

```

