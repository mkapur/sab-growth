---
title: "Individual-Based Population Simulator"
subtitle: "V1.7X, CAPAM 2017"
author: "M Kapur adapted from Chang, Carvalho"
output: NULL
---
The purpose of this script is to extend an existing Individual Based Model to act as an operating model of a low-fecund fishery, the Blue shark. This code builds upon the prior forms in the following ways:
+ addition of a low-fecundity stock-recruitment relationship [citation]
+ general cleanup and shortening of functions; system presets and functions are migrated to separate script system_presets.R
+ ! add BSH LFSR
+ Remove time-varying growth

```{r Setup, message = F, results='hide', echo = F}
library(lattice)
require(dplyr)
require(purrr)
library(RColorBrewer)
require(tidyr)
require(ggplot2)
# devtools::install_github("mkapur/kaputils")
# install.packages( "c:/users/maia kapur/dropbox/kaputils",  repos = NULL, type = "source", dependencies = T)
library(kaputils)
rm(list = ls())
```

Establish Presets & Scenarios

```{r}
options(warn = -1)
nboot <- 100
fLevs <- read.csv('inputs/scenarios.csv',na.strings = 'NA') ## manual file
source('wrangle_data.R')
testrows <- c(1:nrow(fLevs))
```

Initialization (Calculate SSB per recruit)
These all iterate across ages at a yearly time step. Some modules like growth accumulate at a 1/2 year time step.
Current run time:
50 boots, 100 years ~15mins on sebastes
```{r Run Simulation and Save Outputs}

fdf <- data.frame(); idx <- 1
p = proc.time() ## set timer
# for(l in 1:nrow(fLevs)){
for(l in testrows){

  ## if there's a spatial break
  if (fLevs[l, 'CAT'] == 'SPATIAL'  |
      fLevs[l, "CAT"] == 'COMBO') {
  ## special VB params
  source(paste0(getwd(),"/vb_params_", fLevs[l, 'REG'], '.R')); source('system_presets.R') ## system functions 
  } else {
  source(paste0(getwd(),"/vb_params_R1.R")); source('system_presets.R') ## system functions
  }
  
  scenname <- paste0(getwd(),"/",fLevs[l,'DESC']);   if(!exists(scenname)) {dir.create(scenname, showWarnings = F)}
  scenID <-
    ifelse(is.na(fLevs[l, 5]),
    paste(fLevs[l, 3], fLevs[l, 4], sep = "_"),
    paste(fLevs[l, 3], fLevs[l, 4], fLevs[l, 5],  sep = "_"))
  regID <- ifelse(!is.na(fLevs[l,8]),paste(fLevs[l,8]),"")
  out_file0 <- paste0(scenname,"/",regID); 
  if(!exists(out_file0)) {dir.create(out_file0, showWarnings = F)}

  out_file <-  paste0(out_file0,"/",scenID); dir.create(out_file, showWarnings = F)
  ## Remove pre-existing MATRIX files
  # if(exists(out_file)) unlink(out_file, recursive=TRUE) ## delete pre-existing file
  # dir.create(out_file) ## make master FLevel File
  
  for(boot_number in 1:nboot) { ## full nsims, line 20
    cat(paste0(paste(fLevs[l,'DESC']," ",fLevs[l,'ID']),' boot ',boot_number, "\n"))
    ## Designate WRITE location
    path_name <- paste0(out_file,"/boot_",boot_number) 
    dir.create(path_name, showWarnings = F) ## make individual sim file
    maketables(path_name) ## overwrite pre-existing tables, in system_presets
    
    init_comp <- NULL
    init_comp[1] <- 1
    for(g in 2:(a2+1)){
      init_comp[g]=init_comp[g-1]*exp(-Inst_M) ## instantaneous survivorship at age
    }
    init_comp[a2+1] = init_comp[a2+1]/(1-exp(-Inst_M)) #plus group
    
    # Length-at-age 
    init_length = NULL
    error = exp(rnorm(1,0,growth_lognormal_SD)-growth_lognormal_SD^2/2)
    init_length[1] = L1*error
    
    for(g in 1:(a2)){
      init_length[g+1] = (init_length[g]+growth_incre(init_length[g]))*error
    }
    # init_length=init_length[1:a2]
    
    # Weight-at-age
    init_weight = lw(init_length)
    # Maturity-at-age
    init_mat = prob_mature(init_length)
    # Eggs-body mass relationship
    init_eggs = 1*init_weight^0
    # Calculate SSB per recruit
    SSB_per_recruit = sum(0.5*init_comp*init_weight*init_mat*init_eggs)
    # initail SSB
    SSB0 = SSB_per_recruit*R0_super
    
    # Lognormal recruitment deviation module
    recruit_dev = rnorm(simu_year,0,sigma_R)
    recruit_dev_adj = (recruit_dev-0.5*sigma_R^2)
    RECRUITs = round(R0_super*exp(recruit_dev_adj)) ## generate estimated recruit vector of length simu_year
    
    SSBy = NULL
    SSBy[1] = SSB0
    
    uni_ind = 0
    ## Simple gen F vector using original etup
    # Inst_F_vector <- c(rep(0,M_only_yr),generate.effort(F_start_yr))
    Inst_F_vector <- rep(0.000,simu_year+1) ## to make them longer.

    ## save simulated F
    fdf <- rbind(fdf, data.frame(cbind(Inst_F_vector,
                                       1:101, 
                                       rep(idx, 101), 
                                       rep(boot_number,101))))
    
    for(ry in 1:simu_year){ ## iterate sim years
      if(RECRUITs[ry] < 1){ ## fail if less than one recruit
        RECRUITs[ry]=1 ## coerce to 1
        print(paste0("!!! Recruitment Fail !!! year ",ry))
      }
      
      # current_year_by individual
      RECRUITs_year =  rep(1*(ry-1),RECRUITs[ry]) ## vector that lists current year once for each recruit 
      
      # a loop for running each by ind  
      for(i in 1:length(RECRUITs_year)){   ## iterate through each new recruit
        
        uni_ind <- uni_ind + 1
        accumu_yr_1 <- RECRUITs_year[i]+start_yr   
        
        ## GROWTH MODULE: 
        num_of_chance <- length(Inst_F_vector[ry:length(Inst_F_vector)])
        # num_of_chance =  length(ry:length(Inst_F_vector)) ## find length from current recruitment year to end of fishing mortality vector (includes burn in); number of years left
        
        fish_sizes = NULL
        ind_growth_error = exp(rnorm(1,0,growth_lognormal_SD)-growth_lognormal_SD^2/2) ## set individual growth error
        fish_sizes[1]=L1*ind_growth_error ## establish first size
        
        for(g in 1:(num_of_chance-1)){          # next mid year (interval 1 year)
          fish_sizes[g+1] <- (fish_sizes[g]+growth_incre(fish_sizes[g]))*ind_growth_error
        }
                
    
        # Generate a vector of inst_total mortality for this individual;
        ## inst_M is constant, select F vector from given year to end of F vector and multiply by selectivity across fish's lifetime
        inst_Z_vector = Inst_M + Inst_F_vector[ry:length(Inst_F_vector)]*selectivity(fish_sizes)  
         # subset the fish size from the full size-at-age vector (only those that survive grow)
        
         # fish_sizes = fish_sizes[1:a2] ## cut fish_sizes down to max age - this causes problems with multiplication if before inst_z_vector
        inst_Z_vector = inst_Z_vector[1:a2]
        # if(length(inst_Z_vector) >a2){print('length fish size > a2 line 111')}
        

        # random number r1 - bernoulli trial
        r1 = runif(length(inst_Z_vector), 0, 1)
        Zdeath = which.max(r1 <= (1 - exp(-inst_Z_vector))) ## index where r1 is first less than probability of survival (incorporates change)
        fish_sizes = fish_sizes[1:Zdeath] ## trim fish_sizes to time at death
        if(length(fish_sizes) >a2){print('length fish size > a2 line 179')}
        
        ## SIZE-AT-TIME BOOKKEEPING 
        true_age = 1:Zdeath-1 ## actual lifespan before zdeath
        AgeE = rnorm(length(true_age),mean_age_true_age[true_age+1],mean_SD_age_true_age[true_age+1]) 
        AgeE[AgeE<0]=0
        
        SAA <- data.frame(
          cohort = rep(ry, Zdeath),
          uni_ind = rep(uni_ind, Zdeath), ## changed this to rep length Zdeath so it'd match
          ind = rep(i, Zdeath),
          fish_size = fish_sizes[1:Zdeath],
          Year = accumu_yr_1 + 1:Zdeath - 1,
          Age = true_age,
          AgeE = AgeE,
          FMORT = c(Inst_F_vector[ry:(ry + Zdeath - 1)]),
          M = rep(Inst_M, Zdeath),  ## changed this to rep length Zdeath so it'd match
          Sel = c(selectivity(fish_sizes)),
           # Sel = c(selectivity(true_age)),

          FSIM = paste(fLevs[l,"FMORT_1"],fLevs[l,"FMORT_2"],fLevs[l,"FMORT_3"]),
          REG = fLevs[l,"REG"]
        )
        
        ## MORTALITY MODULE:
        # seperate inst_total mortality into F and M
        M_dead_por = (1 - exp(-Inst_M)) / (1 - exp(-inst_Z_vector[Zdeath])) ## nat survivorship over overall survivorship. Will be 1 for years with only nat mort in effect.
        r2 = runif(1, 0, 1) ## bernoulli trial
        true_age = Zdeath - 1
        AgeE = rnorm(1, mean_age_true_age[true_age + 1], mean_SD_age_true_age[true_age +
        1])
        AgeE[AgeE < 0] = 0
        
        ## write dinfo 
        # dinfo = data.frame(
        #   cohort = c(ry),
        #   ind = c(i),
        #   fish_size = fish_sizes[Zdeath],
        #   Year = accumu_yr_1 + Zdeath - 1,
        #   Age = true_age,
        #   AgeE = AgeE,
        #   dtype = NA, ## fill in next based on log-odds (r2)
        #   FMORT = c(Inst_F_vector[ry + Zdeath - 1]),
        #   M = c(Inst_M),
        #   Sel = c(selectivity(fish_sizes[Zdeath])),
        # 
        #   FSIM = paste(fLevs[l,"FMORT_1"],fLevs[l,"FMORT_2"],fLevs[l,"FMORT_3"]),
        #   REG = fLevs[l,"REG"]
        # 
        # )
        
        # dinfo$dtype = ifelse(r2 <= M_dead_por, "M", "FISHED")
        
        ## write data to file - one for each F level
       write.table(SAA, paste(path_name,"/IBM_SAA_MATRIX.txt",sep=""),
                   append = TRUE,
                   row.names = FALSE,
                   col.names = FALSE,
                   sep=",")
        # write.table(dinfo,paste(path_name,"/IBM_DEAD_MATRIX.txt",sep=""),append = TRUE,row.names = FALSE,col.names = FALSE,sep=",")
        

      } ## end of individual recruit
      
      ## STOCK-RECRUITMENT MODULE
        # Update number of recruits by B-H stock recruitment relationship
        # Recruitment derived from B-H S-R start from the second year of fishing mortality
        
        if (ry > M_only_yr & ry <= (simu_year - 1)) { ## only perform SRR for years after M only and before last year
          tempSAA = read.table(paste0(path_name, "/IBM_SAA_MATRIX.txt"),header = T, sep = ',') ## read current size-at-age-table
          tempN = subset(tempSAA, Year == (ry + start_yr - 1)) ## extract PREVIOUS year
          tempW = lw(tempN$fish_size) ## calc weights
          tempMat = prob_mature(tempN$fish_size) ## calc prob of maturity at size
          tempE = 1 * tempW ^ 0 ## ! unsure
          SSBy[ry] = sum(tempW * tempMat * tempE) / 2 ## SSB for this year (half step) is the sum of all biomasses & prob maturity
          RECRUITs[ry + 1] = round(BH_SR(SSBy[ry]) * exp(recruit_dev_adj[ry])) ## next year's recruits are the bev-holt or LFSR of the SSB with error
        } ## end of recruitment generation for that year
    } ## end of simu_year (ry)
  } ## end of boots
  idx <- idx + 1
  genDat <- build_simComp(out_file,l=l)
  plotComps(dat1 = genDat[[1]], dat2 = genDat[[2]], datN = genDat[[3]], scenID  = genDat[[4]], saveloc = 1)
  rm(genDat)
} ## end of fLev[l]
print(paste("Full simulation time ",((proc.time()-p)/60)[1],"min(s)"))


names(fdf) <- c('F_std','Year','MOD','boot')
fdf$MOD <- as.factor(fdf$MOD)
write.csv(fdf,file=paste0(getwd(),"/genData/Fsim.csv"),row.names = F )
```


Read in both regions' subsampled data frame from each regime; nesting varies depending whether there was a spatial regime or not. Apply breakpoints if specified in `scenarios`. Save this to genData, and plot compiled A-L comp plots to plots/. Now you have a dataset with temporal and spatial breaks as specified.
```{r assign spatial, echo = T}
# for(l in 1:nrow(fLevs)){
for(l in testrows){
  
  sptl <- fLevs[l,"SPATIAL"]
  scenname <- paste0(getwd(),"/",fLevs[l,'DESC'])
  scenID <-
    ifelse(is.na(fLevs[l, 5]),
           paste(fLevs[l, 3], fLevs[l, 4], sep = "_"),
           paste(fLevs[l, 3], fLevs[l, 4], fLevs[l, 5],  sep = "_"))
  regID <- ifelse(!is.na(fLevs[l,8]),paste(fLevs[l,8]),"")
  out_file0 <- paste0(scenname,"/",regID)
  out_file <-  paste0(out_file0,"/",scenID)
    
  # if(fLevs[l,'CAT'] %in% c('NONE','SPATIAL')){ ## if spatial only, aggregate all and split regionally
    
    for(b in 1:nboot){ ## pair boots
      cat("row ",l,"boot ",b, "\n")
      dat <- list.files(scenname, full.names = T,recursive = T)[grep(paste0(b,'sim_Comp'),list.files(scenname, full.names = T, recursive = T))] %>%
        lapply(read.csv,sep=",",header=T) %>%
        reduce(bind_rows)
      makeLat(dat) %>% write.csv(., paste0(getwd(),"/genData/",basename(scenname),"_",scenID,"_",b,".csv"),row.names = F)
    }
    # dat <- read.table(paste0(out_file,"/",scenID,b,"sim_Comp.csv"),sep = ",",header = T) %>% filter(Year %in% c(50:100))
    
    # names(dat)[4] <- "fish_size"
    # genDat <- build_simComp(dat0=dat,l=l) ## make stuff for plotting
    # plotComps(dat1 = genDat[[1]], dat2 = genDat[[2]], datN = genDat[[3]], scenID = genDat[[4]], saveloc = NA) ## all regions together
    # names(dat)[4] <- "Length_cm"
    
  # }  else if(fLevs[l,'CAT'] %in% c('TEMPORAL', 'COMBO')) { ## merge by flev and region
  #   for(b in 1:nboot){ ## pair boots
  #     dat <-
  #       list.files(out_file, full.names = T, recursive = T)[grep(paste0(b, 'sim_Comp'),
  #                                                                list.files(out_file, full.names = T, recursive = T))] %>%  
  #       lapply(read.csv, sep = ",", header = T) %>% 
  #       reduce(bind_rows) 
  #     makeLat(dat) %>% write.csv(., paste0(getwd(),"/genData/",basename(scenname),"_",scenID,"_",b,".csv"),row.names = F)
  #   } ## end boot
  # } ## end else
}  ## end levs
    
    
    # moddrop <- NA
    # for(m in 1:length(lev0)){
    #   if(length(list.dirs(lev0[m], recursive = F)) > 0)  moddrop[m] <- m
    # }
    # moddrop <- moddrop[!is.na(moddrop)]
    # if(length(moddrop >0)) lev0 <- lev0[-moddrop]
    ## get pre-sampled age/length data
    # dat <- list.files(scenname, recursive = T, full.names = T)[grep(paste0(scenID,'sim_Comp.csv'),list.files(scenname, recursive = T, full.names = T))] %>%
    #   lapply(read.csv) %>%
    #   reduce(bind_rows) %>%
    #   filter(Year %in% c(50:100))

## Plot F trajectory one time
 fdf %>% 
   filter(MOD %in% floor(runif(8,1,8)) & boot == 2) %>%
  kaputils::plotF(SPRseries =., saveplot = T, pdfcols = 1, plotloc = "C:/Users/maia kapur/Dropbox/UW/sab-growth/iPopSim/plots")

```

